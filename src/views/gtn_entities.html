<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Simulador de Crédito/Inversión </title>
        <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css'>
        <link rel='stylesheet' href='https://unicons.iconscout.com/release/v2.1.9/css/unicons.css'>
        <link rel="stylesheet" href="../styles/style.css">
        <script src="purify.min.js"></script>
    </head>
    <body style="overflow-y: scroll;">
        <nav class="menu__wrapper">
            <div class="logo__wrapper">
                <a
                    href="../index.html"
                    title="Logo"
                    class="logo"
                >
                <svg height="32" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="32" data-view-component="true">
                    <image href="../assets/bank.svg" width="16" height="16" />
                </svg>
                </a>
                <a href="../index.html" class="page__title">
                    Dashboard
                </a>
            </div>
            <div class="action-buttons"> 

				<button id="btnGtnEntities" onclick="hrefGtnEntities()" class="action-button">
                    <svg aria-hidden="true" height="24" viewBox="0 0 22 22" version="1.1" width="24" data-view-component="true" class="octicon octicon-git-pull-request Button-visual">
                        <image class="img_nav" href="../assets/entity.svg" width="24" height="24"/>
                    </svg>
                </button>
				
				<button id="btnAddUser" onclick="hrefAddUser()" class="action-button">
                    <svg aria-hidden="true" height="24" viewBox="0 0 22 22" version="1.1" width="24" data-view-component="true" class="octicon octicon-git-pull-request Button-visual">
                        <image class="img_nav" href="../assets/add-user.svg" width="24" height="24"/>
                    </svg>
                </button>

                <button id="btnCerrarSesion" onclick="logOut()" class="action-button" style="margin-right: 20px;">
                    <svg aria-hidden="true" height="24" viewBox="0 0 22 22" version="1.1" width="24" data-view-component="true" class="octicon octicon-git-pull-request Button-visual">
                        <image class="img_nav" href="../assets/signout.svg" width="24" height="24"/>
                    </svg>
                </button>
            </div>
        </nav>

        <div class="center-wrap-gtn" style="width: 500px; top: 15%; display: grid; grid-template-columns: 60fr 60fr; gap: 60px;">
            <div class="section text-center">
                <div class="form-group mt-2">
                    <select style="width: 300px;"
                    name="frecInv" class="form-style" id="frecInv">
                        <option value="" disabled selected>Entidad Financiera</option>
                        
                    </select>
                    <i class="input-icon uil uil-university"></i>
                </div>
            </div>
            <a style="width: 300px;" id="btnOpenModal" onclick="openModal()" href="#" class="btn mt-4">Registrar cobros indirectos</a>
        </div>

        <div class="container-tables">
            <div class="table-widget">
                <span class="caption-container">
                    <span class="table-title">
                        Créditos
                    </span>
                    <span class="table-row-count tableCred"></span>
                    <button id="btnAddCred" class="btn btn--primary" style="margin-left: 65px;">Crear</button>
                </span>
                <div class="table-wrapper tableWrCred">
                    <!-- generate table here -->
                </div>
            </div>
            
            <div class="table-widget">
                <span class="caption-container">
                    <span class="table-title">
                        Inversiones
                    </span>
                    <span class="table-row-count tableInvest"></span>
                    <button id="btnAddInvest" class="btn btn--primary" style="margin-left: 65px;">Crear</button>
                </span>
                <div class="table-wrapper tableWrInvest">
                    <!-- generate table here -->
                </div>
            </div>
        </div>

        <div id="modal" class="modal-ci">
            <div class="modal-content">
                <h2>Registro de cobros indirectos</h2>
                <div class="form-group">
                    <input class="form-style" placeholder="Nombre del cobro indirecto" id="nameCobroInd" type="text" style="margin-bottom: 10px; width: 390px;">
                    <i class="input-icon uil uil-pen"></i>
                </div>
                <div class="form-group">
                    <input class="form-style" placeholder="Monto $" id="montoCobroInd" type="text" style="width: 390px;">
                    <i class="input-icon uil uil-dollar-alt"></i>
                </div>
                <div class="dropzone-actions">
                    <a id="btnRegisterCobrInd" onclick="registerCobroIndirecto()" href="javascript:void(0)" class="btn mt-4">Guardar</a>
                    <a id="btnCancelRegCobrInd" onclick="closeModal()" href="javascript:void(0)" class="btn mt-4">Cancelar</a>
                </div>
            </div>
        </div>
        
        <script>
            function openModal() {
                var modal = document.getElementById("modal");
                modal.style.display = "block";
            }

            function closeModal() {
                var modal = document.getElementById("modal");
                modal.style.display = "none";
            }

            function logOut() {
                localStorage.removeItem('token');
                window.location.href = "../index.html";
            }

            function hrefAddUser() {
                window.location.href = "register_user.html"
            }

            function hrefGtnEntities() {
                window.location.href = "gtn_entities.html"
            }

            document.addEventListener("DOMContentLoaded", function() {

                const btnRegisterCobrInd = document.getElementById("btnRegisterCobrInd");
                btnRegisterCobrInd.addEventListener("click", registerCobroIndirecto);

                const btnAddCred = document.getElementById("btnAddCred");

                btnAddCred.addEventListener("click", function() {
                // Obtener referencia a la tabla
                const table = document.querySelector('.table-wrapper.tableWrCred table');

                // Crear una nueva fila
                const newRow = table.insertRow(-1);

                // Agregar dos celdas a la fila para ingresar datos
                const cell1 = newRow.insertCell(0);
                const cell2 = newRow.insertCell(1);

                // Agregar inputs a las celdas
                cell1.innerHTML = '<input style="width: 130px;" type="text" placeholder="Ingrese Nombre">';
                cell2.innerHTML = '<input style="width: 90px;" type="text" placeholder="Ingrese Tasa de Interes">';

                // Agregar dos botones a la fila ("Aceptar" y "Cancelar")
                const cell3 = newRow.insertCell(2);
                const cell4 = newRow.insertCell(3);
                cell3.innerHTML = '<button style="width: 5px; padding-left: 25px; padding-right: 25px;" class="btn btn--success">✔</button>';
                cell4.innerHTML = '<button style="width: 5px; padding-left: 25px; padding-right: 25px; margin-left: -17px;" class="btn btn--danger">✘</button>';

                // Agregar evento de clic al botón "Cancelar"
                cell4.querySelector('button').addEventListener("click", function() {
                    // Eliminar la fila al hacer clic en "Cancelar"
                    table.deleteRow(newRow.rowIndex);
                });

                cell3.querySelector('button').addEventListener("click", function() {
                    const nameCred = cell1.querySelector('input').value;
                    const rateCred = cell2.querySelector('input').value;
                    registerTypeCredit(nameCred, rateCred);
                });
            });

            const btnAddInvest = document.getElementById("btnAddInvest");

            btnAddInvest.addEventListener("click", function() {
                // Obtener referencia a la tabla
                const table = document.querySelector('.table-wrapper.tableWrInvest table');

                // Crear una nueva fila
                const newRow = table.insertRow(-1);

                // Agregar dos celdas a la fila para ingresar datos
                const cell1 = newRow.insertCell(0);
                const cell2 = newRow.insertCell(1);

                // Agregar inputs a las celdas
                cell1.innerHTML = '<input style="width: 130px;" type="text" placeholder="Ingrese Nombre">';
                cell2.innerHTML = '<input style="width: 90px;" type="text" placeholder="Ingrese Tasa de Interes">';

                // Agregar dos botones a la fila ("Aceptar" y "Cancelar")
                const cell3 = newRow.insertCell(2);
                const cell4 = newRow.insertCell(3);
                cell3.innerHTML = '<button style="width: 5px; padding-left: 25px; padding-right: 25px;" class="btn btn--success">✔</button>';
                cell4.innerHTML = '<button style="width: 5px; padding-left: 25px; padding-right: 25px; margin-left: -17px;" class="btn btn--danger">✘</button>';

                // Agregar evento de clic al botón "Cancelar"
                cell4.querySelector('button').addEventListener("click", function() {
                    // Eliminar la fila al hacer clic en "Cancelar"
                    table.deleteRow(newRow.rowIndex);
                });

                cell3.querySelector('button').addEventListener("click", function() {
                    const nameInvest = cell1.querySelector('input').value;
                    const rateInvest = cell2.querySelector('input').value;
                    registerTypeInvest(nameInvest, rateInvest);
                });
            });


            async function registerCobroIndirecto() {

                const nameCobroInd = document.getElementById('nameCobroInd').value;
                const montoCobroInd = document.getElementById('montoCobroInd').value;
                const selectedOption = select.options[select.selectedIndex];
                const selectedValue = selectedOption.value;

                if (nameCobroInd !== '' && montoCobroInd !== '') {

                    const token = localStorage.getItem('token');

                    const dataCobrInd = {
                        id_ent_per: selectedValue,
                        name_cobro: nameCobroInd,
                        monto_cobro: montoCobroInd
                    };

                    fetch('http://localhost/simuladorCredInver-apirest/api-rest/registerCobroIndirecto', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(dataCobrInd)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status == 'OK') {
                            window.alert("Registro Satisfactorio")
                            window.location.href = "gtn_entities.html";
                        } else {
                            window.alert("Error al generar registrar")
                        }       
                    })
                    .catch(error => {
                        console.error('Error del servidor', error);
                    });
                } else {
                    window.alert("Se requiere todos los campos");
                }
                }

            async function registerTypeCredit(nameCred, rateCred) {

                const selectedOption = select.options[select.selectedIndex];
                const selectedValue = selectedOption.value;

                if (nameCred !== '' && rateCred !== '') {

                    const token = localStorage.getItem('token');

                    const dataTypeCred = {
                        id_ent_per: selectedValue,
                        name_cred: nameCred,
                        rate_cred: rateCred 
                    };

                    fetch('http://localhost/simuladorCredInver-apirest/api-rest/registerTypeCredit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(dataTypeCred)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status == 'OK') {
                            window.alert("Registrado correctamente");
                            window.location.href = "gtn_entities.html";
                        } else {
                            window.alert("Credenciales incorrectas")
                        }       
                    })
                    .catch(error => {
                        console.error('Error del servidor', error);
                    });
                } else {
                    window.alert("Se requiere todos los campos");
                }
            }

            async function registerTypeInvest(nameInvest, rateInvest) {

                const selectedOption = select.options[select.selectedIndex];
                const selectedValue = selectedOption.value;

                if (nameInvest !== '' && rateInvest !== '') {

                    const token = localStorage.getItem('token');

                    const dataTypeInvest = {
                        id_ent_per: selectedValue,
                        name_invest: nameInvest,
                        rate_invest: rateInvest 
                    };

                    fetch('http://localhost/simuladorCredInver-apirest/api-rest/registerTypeInvestment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(dataTypeInvest)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status == 'OK') {
                            window.alert("Registrado correctamente");
                            window.location.href = "gtn_entities.html";
                        } else {
                            window.alert("Credenciales incorrectas")
                        }       
                    })
                    .catch(error => {
                        console.error('Error del servidor', error);
                    });
                } else {
                    window.alert("Se requiere todos los campos");
                }
                }

                async function getEntityFinancial() {

                    let listEntities = [];

                    try {
                    const response = await fetch('http://localhost/simuladorCredInver-apirest/api-rest/getFinancialEntity');
                    const data = await response.json();
                
                    if (data.status == 'OK') {
                        listEntities = data.entities;
                        return listEntities;
                    } else {
                        console.error('La respuesta de la API no fue exitosa:', data.status);
                        return listEntities; // Devuelve la lista vacía en caso de error
                    }
                
                    } catch (error) {
                        console.error('Error del servidor:', error);
                        return listEntities;
                    }
                }

                async function getTypeCredits(id_entity) {

                    if (id_entity != 0) {
                        const id = {
                            "id_entity": id_entity
                        };

                        fetch('http://localhost/simuladorCredInver-apirest/api-rest/getTypesCredits', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(id)
                        })
                        .then(response => response.json())
                        .then(data=> {
                            if (data.status == 'OK') {
                                loadTableCredits(data.types_credits)
                            }
                        })
                        .catch(error => {
                            console.error('Error del servidor', error);
                        });
                    } 
                }

                async function getTypeInvestments(id_entity) {

                    if (id_entity != 0) {
                        const id = {
                            "id_entity": id_entity
                        };

                        fetch('http://localhost/simuladorCredInver-apirest/api-rest/getTypesInvestments', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(id)
                        })
                        .then(response => response.json())
                        .then(data=> {
                            if (data.status == 'OK') {
                                loadTableInvest(data.types_investments)
                            }
                        })
                        .catch(error => {
                            console.error('Error del servidor', error);
                        });
                    } 
                }

                function loadTableCredits (typeCredits) {

                    let tableRowCount = document.getElementsByClassName('tableCred');
                    tableRowCount[0].innerHTML = `(${typeCredits.length}) Existentes`;

                    let tableBody = document.getElementById('table-rows-cred');

                    const mappedRecords = typeCredits
                    .map(
                    (typeCredit) => {
                        return `<tr>
                        
                        <td class="text-table">${typeCredit.name_cred}</td>
                        <td class="text-table">${typeCredit.rate_cred}</td>
                                        
                        <td class="sticky-right">
                            <button class="btn btn--primary">Eliminar</button>
                        </td>
                    </tr>`;
                    });

                    const tableWrapper = document.querySelector('.tableWrCred');

                    tableWrapper.innerHTML = DOMPurify.sanitize(`
                        <table>
                            <thead>
                                <tr>
                                    <th>Nombre Crédito</th>
                                    <th>Tasa de Interés</th>
                                    <th class="sticky-right"></th>
                                </tr>
                            </thead>
                            <tbody id="table-rows-cred">
                                ${mappedRecords.join('')}
                            </tbody>                    
                        </table>
                    `);
                }

                function loadTableInvest(typeInvest) {

                    let tableRowCount = document.getElementsByClassName('tableInvest');
                    tableRowCount[0].innerHTML = `(${typeInvest.length}) Existentes`;

                    let tableBody = document.getElementById('table-rows-invest');

                    const mappedRecords = typeInvest
                    .map(
                    (typeInvest) => {
                        return `<tr>
                        
                        <td class="text-table">${typeInvest.name_invest}</td>
                        <td class="text-table">${typeInvest.rate_invest}</td>
                                        
                        <td class="sticky-right">
                            <button class="btn btn--primary">Eliminar</button>
                        </td>
                    </tr>`;
                    });

                    const tableWrapper = document.querySelector('.tableWrInvest');

                    tableWrapper.innerHTML = DOMPurify.sanitize(`
                        <table>
                            <thead>
                                <tr>
                                    <th>Nombre Crédito</th>
                                    <th>Tasa de Interés</th>
                                    <th class="sticky-right"></th>
                                </tr>
                            </thead>
                            <tbody id="table-rows-invest">
                                ${mappedRecords.join('')}
                            </tbody>                    
                        </table>
                    `);
                }

                const select = document.getElementById("frecInv");

                getEntityFinancial().then(listEntities => {
                listEntities.forEach(opcion => {
                    const option = document.createElement("option");
                    option.value = opcion.id; 
                    option.textContent = opcion.name;
                    select.appendChild(option);
                });
                }).catch(error => {
                    console.error("Error al cargar las entidades financieras:", error);
                });

                    select.addEventListener("change", function() {
                        const idSelected = this.value;
                        getTypeCredits(idSelected);
                        getTypeInvestments(idSelected);
                    });
                });

        </script>
    </body>
</html>